<%= form_with model: @request do |f| %>
  <%= f.label :amount %>
  <%= f.text_field :amount, {id: 'amount', onchange: "updateFields()"}%>

  <%= f.label :periods %>
  <%= f.select :periods, options_for_select(available_periods),{}, { onchange: "updateFields()", id: 'period'} %>

  <%= f.label :monthly_fee, 'Taxa mensal(%)'%>
  <%= f.text_field :monthly_fee, {readonly: true, id: 'monthly_fee'} %>

  <%= f.label :total, 'Total a pagar'%>
  <%= f.text_field :total, {readonly: true, id: 'total'} %>

  <%= f.hidden_field :company_id, value: @company.id %>

  <%= f.submit %>
<% end %>

<%= javascript_tag do %>
  async function updateFields(){
    await getFee();
    await getTotal();
  }

  async function getFee() {
    let selectedPeriod = $('#period').val();

    let url = "/api/fee_by_period?period=" + selectedPeriod;

    await $.ajax({
      url: url,
      type: "get",
      data: "",
      success: function(data) {
        updateFee(data.current_fee);
      },
      error: function(data) {
        alert('Ocorreu um erro ao atualizar os dados.');
      }
    })
  }

  function updateFee(fee) {
    let readableFee = (fee * 100)
    $('#monthly_fee').val(readableFee);
  }

  async function getTotal() {
    let currentAmount = $('#amount').val();
    let currentMonthlyFee = $('#monthly_fee').val();
    let currentPeriods = $('#period').val();

    let url = "/api/calculate_pmt?amount="+currentAmount+"&monthly_fee="+currentMonthlyFee+"&periods="+currentPeriods;

    await $.ajax({
      url: url,
      type: "get",
      data: "",
      success: function(data) {
        updateTotal(data.total);
      },
      error: function(data) {
        alert('Ocorreu um erro ao atualizar os dados.');
      }
    })
  }

  function updateTotal(total) {
    $('#total').val(total);
  }
<% end %>
